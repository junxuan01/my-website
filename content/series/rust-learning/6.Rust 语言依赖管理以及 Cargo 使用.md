---
title: "Rust 语言依赖管理以及 Cargo 使用"
description: "学习 Rust 的包管理器 Cargo，了解 Cargo.toml、依赖管理和常用命令。"
date: "2025-11-30"
seriesOrder: 6
---

# 6. Rust 语言依赖管理以及 Cargo 使用

## 引言

在 JavaScript 世界中，我们离不开 `npm`（或 yarn/pnpm）和 `package.json`。它们负责管理项目依赖、运行脚本和发布包。

在 Rust 世界中，这个角色由 **Cargo** 扮演。Cargo 不仅仅是一个包管理器，它还是构建系统、测试运行器和文档生成器。对于前端开发者来说，Cargo 的体验非常亲切，甚至在某些方面（如依赖解析算法、工作空间支持）比 npm 更加优秀。

本篇文章将深入讲解 Cargo 的核心用法，帮助你像管理 npm 项目一样管理 Rust 项目。

## 1. Cargo.toml：项目的灵魂

当你运行 `cargo new my_project` 时，Cargo 会生成一个 `Cargo.toml` 文件。这相当于 npm 的 `package.json`。

### 1.1 文件结构

```toml
[package]
name = "my_project"
version = "0.1.0"
edition = "2021"
authors = ["Your Name <you@example.com>"]
description = "A simple Rust project"

[dependencies]
serde = "1.0"
rand = "0.8.5"

[dev-dependencies]
pretty_assertions = "1.0"
```

*   **[package]**：定义项目的元数据（名称、版本、作者等）。
*   **[dependencies]**：定义生产环境依赖（相当于 `dependencies`）。
*   **[dev-dependencies]**：定义开发/测试环境依赖（相当于 `devDependencies`）。

### 1.2 版本号规则 (SemVer)

Rust 严格遵循 **语义化版本 (Semantic Versioning)** 规范。

*   `serde = "1.0"` 等同于 `^1.0`，表示允许更新到 `< 2.0.0` 的任何版本（如 1.0.1, 1.5.0）。
*   `rand = "0.8.5"` 等同于 `^0.8.5`，表示允许更新到 `< 0.9.0` 的版本。

这与 npm 的默认行为（使用 `^`）是一致的。

## 2. 依赖管理

### 2.1 添加依赖

你可以手动编辑 `Cargo.toml`，也可以使用命令行工具 `cargo add`（Rust 1.62+ 内置）。

```bash
# 添加依赖 (默认添加到 [dependencies])
cargo add serde

# 添加特定功能的依赖 (开启 feature)
cargo add serde --features derive

# 添加开发依赖 (添加到 [dev-dependencies])
cargo add pretty_assertions --dev
```

### 2.2 Cargo.lock

当你第一次运行 `cargo build` 时，Cargo 会生成一个 `Cargo.lock` 文件。这相当于 npm 的 `package-lock.json` 或 yarn 的 `yarn.lock`。

*   **作用**：锁定依赖的确切版本，确保在不同机器上构建的结果完全一致。
*   **建议**：如果是**应用程序**（Application），请将 `Cargo.lock` 提交到 Git；如果是**库**（Library），通常不提交（让使用者决定版本），但现在的最佳实践也建议提交以保证 CI 稳定性。

### 2.3 更新依赖

```bash
# 更新所有依赖到符合 Cargo.toml 约束的最新版本
cargo update

# 更新特定依赖
cargo update -p rand
```

## 3. 常用命令详解

### 3.1 构建与运行

*   `cargo build`：编译项目。默认是 **Debug** 模式，编译速度快，但运行速度慢，且包含调试信息。生成在 `target/debug/`。
*   `cargo run`：编译并运行。
*   `cargo build --release`：**Release** 模式编译。开启最高级别的优化（O3），编译慢，但运行极快。生成在 `target/release/`。**生产环境部署必须用这个！**

### 3.2 检查与测试

*   `cargo check`：**非常常用**。它只检查代码是否能通过编译，但不生成可执行文件。速度比 `cargo build` 快得多，适合开发过程中频繁运行以检查语法错误。
*   `cargo test`：运行项目中的单元测试和集成测试。
*   `cargo clippy`：运行 Linter，提供代码改进建议。

### 3.3 文档

*   `cargo doc`：为项目及其所有依赖生成 HTML 文档。
*   `cargo doc --open`：生成并自动在浏览器中打开。这对于离线查看第三方库文档非常有用。

## 4. 工作空间 (Workspace)

当你的项目变得很大，或者你想在一个仓库中管理多个包（Monorepo）时，可以使用 Workspace。这类似于 npm 的 Workspaces 或 pnpm workspace。

### 4.1 目录结构

```
my-workspace/
├── Cargo.toml   # 根配置
├── crates/
│   ├── api/     # 子包 1
│   │   └── Cargo.toml
│   └── core/    # 子包 2
│       └── Cargo.toml
```

### 4.2 配置 Workspace

在根目录的 `Cargo.toml` 中：

```toml
[workspace]
members = [
    "crates/api",
    "crates/core",
]

[workspace.dependencies]
# 可以在这里定义公共依赖版本
serde = "1.0.188"
```

在子包中引用公共依赖：

```toml
# crates/api/Cargo.toml
[dependencies]
serde = { workspace = true }
```

这样可以确保所有子包使用相同版本的依赖，减少编译时间及产物体积。

## 5. 镜像源配置（复习）

我们在上一篇中已经讲过，为了加速下载，建议配置国内镜像。

在 `~/.cargo/config.toml` 中：

```toml
[source.crates-io]
replace-with = 'ustc'

[source.ustc]
registry = "sparse+https://mirrors.ustc.edu.cn/crates.io-index/"
```

## 6. 总结

Cargo 是 Rust 生态系统中不可或缺的一部分，它的设计非常现代化且人性化。

*   **Cargo.toml** 定义项目元数据和依赖。
*   **Cargo.lock** 锁定依赖版本。
*   **cargo check** 是开发中最常用的命令。
*   **cargo build --release** 用于生产构建。
*   **Workspace** 支持 Monorepo 开发模式。

掌握了 Cargo，你就掌握了管理 Rust 项目的钥匙。下一篇，我们将正式进入 Rust 语法的学习，从变量和常量开始。

---

