---
title: "交付：Docker 容器化与云原生部署"
description: "后端开发的最后一公里。编写 Dockerfile 构建最小化镜像。使用 Docker Compose 编排 Go 应用、MySQL、Redis 和 RabbitMQ，实现一键部署。"
date: "2025-12-12"
seriesOrder: 10
---

# 10. 交付：Docker 容器化与云原生部署

## 引言

"在我的机器上是好的，为什么在服务器上跑不起来？"
这是开发和运维之间最经典的争吵。

**Docker** 的出现彻底终结了这个问题。它将代码、运行时、系统库、配置文件全部打包到一个**镜像 (Image)** 中，保证了环境的一致性。

作为本系列的终章，我们将把 Go-Blog-API 以及它依赖的 MySQL、Redis、RabbitMQ 全部容器化，实现**一键启动**。

## 1. 编写 Dockerfile

Go 语言的一大优势是编译产物只是一个二进制文件。我们可以利用 **多阶段构建 (Multi-stage Build)** 来制作极小的镜像。

在项目根目录创建 `Dockerfile`：

```dockerfile
# 阶段一：构建阶段
FROM golang:1.25-alpine AS builder

# 设置环境变量
ENV GO111MODULE=on \
    GOPROXY=https://goproxy.cn,direct

WORKDIR /app

# 预下载依赖 (利用 Docker 缓存)
COPY go.mod go.sum ./
RUN go mod download

# 复制源码并编译
COPY . .
RUN go build -o server cmd/server/main.go

# 阶段二：运行阶段
FROM alpine:latest

WORKDIR /app

# 从构建阶段复制二进制文件
COPY --from=builder /app/server .
# 复制配置文件
COPY --from=builder /app/configs ./configs

# 暴露端口
EXPOSE 8080

# 启动命令
CMD ["./server"]
```

这个镜像的大小通常只有 20MB 左右，非常轻量。

## 2. 编写 Docker Compose

我们需要编排 4 个容器：App, MySQL, Redis, RabbitMQ。

创建 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8080:8080"
    depends_on:
      - mysql
      - redis
      - rabbitmq
    environment:
      - CONFIG_PATH=configs/config.docker.yaml # 假设我们支持环境变量覆盖配置路径
    networks:
      - blog-net

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: blog_db
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - blog-net

  redis:
    image: redis:7.0
    networks:
      - blog-net

  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "15672:15672" # 管理界面端口
      - "5672:5672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    networks:
      - blog-net

networks:
  blog-net:

volumes:
  mysql_data:
```

## 3. 修改配置

在 Docker 网络中，服务之间通过**服务名**互相访问，而不是 `localhost`。

我们需要创建一个专门给 Docker 使用的配置文件 `configs/config.docker.yaml`：

```yaml
server:
  port: "8080"
  mode: "release"

database:
  # 注意 host 变成了 mysql
  dsn: "root:root@tcp(mysql:3306)/blog_db?charset=utf8mb4&parseTime=True&loc=Local"

redis:
  # 注意 host 变成了 redis
  addr: "redis:6379"

rabbitmq:
  # 注意 host 变成了 rabbitmq
  url: "amqp://guest:guest@rabbitmq:5672/"
```

并在代码中支持根据环境变量加载不同的配置文件。

## 4. 一键部署

在服务器上（或本地安装了 Docker 的机器上），只需执行一条命令：

```bash
docker-compose up -d --build
```

Docker 会自动：
1.  拉取 MySQL, Redis, RabbitMQ 镜像。
2.  根据 Dockerfile 构建我们的 App 镜像。
3.  创建虚拟网络。
4.  按顺序启动所有容器。

你可以通过 `docker-compose ps` 查看运行状态。

## 5. 结语：从入门到架构师

恭喜你！你已经完成了《Go Web 后端架构实战》的全部课程。

回顾一下我们的旅程：
1.  **启程**：转变思维，建立标准项目结构。
2.  **核心**：掌握 Gin 框架与 RESTful 设计。
3.  **数据**：深入 GORM，理解逻辑外键。
4.  **架构**：实现 CSR 分层与依赖注入。
5.  **安全**：JWT 鉴权与中间件。
6.  **交互**：解决 N+1 问题，实现事务与分页。
7.  **性能**：Redis 缓存策略与分布式锁。
8.  **异步**：RabbitMQ 解耦与削峰。
9.  **稳健**：单元测试与 Swagger 文档。
10. **交付**：Docker 容器化部署。

这不仅仅是一个博客系统，更是一套**可复用的企业级后端架构模版**。希望这套知识体系能帮助你在后端开发的道路上走得更远、更稳。

**Keep Coding, Keep Learning!**
